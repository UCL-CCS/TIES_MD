<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial &mdash; TIES_MD 1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="TIES MD API" href="API.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #D7ECD9" >
            <a href="index.html" class="icon icon-home"> TIES_MD
            <img src="_static/TIES_logov2.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="#input">Input</a></li>
<li class="toctree-l2"><a class="reference internal" href="#command-line">Command Line</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simulation-preparation">Simulation Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-simulations">Running Simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#analysis">Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="API.html">TIES MD API</a></li>
<li class="toctree-l1"><a class="reference internal" href="binding_free_energies.html">Binding Free Energy Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallelization.html">Parallelization</a></li>
<li class="toctree-l1"><a class="reference internal" href="HPC_submissions.html">HPC Submission scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="theory.html">Theory</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/UCL-CCS/TIES_MD">üöÄGithub</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">TIES_MD</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #D7ECD9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">TIES_MD</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this heading">ÔÉÅ</a></h1>
<section id="getting-started">
<h2>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this heading">ÔÉÅ</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">TIES</span> <span class="pre">MD</span></code> is a package for the preparation, running and analysis of binding free energy calculations. In this document
we will outline what commands should be run to calculate binding free energies. To start with any free energy calculations
we must first outline what are the expected input files to the <code class="docutils literal notranslate"><span class="pre">TIES</span> <span class="pre">MD</span></code> program.</p>
<p>In this tutorial we will refer to example systems which can be found in the
<a class="reference external" href="https://github.com/UCL-CCS/TIES_MD/tree/main/TIES_MD/examples">source code</a>. These examples can be download by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">UCL</span><span class="o">-</span><span class="n">CCS</span><span class="o">/</span><span class="n">TIES_MD</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>and found by navigating to <code class="docutils literal notranslate"><span class="pre">TIES_MD/TIES_MD/examples/</span></code></p>
</section>
<section id="input">
<h2>Input<a class="headerlink" href="#input" title="Permalink to this heading">ÔÉÅ</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">TIES</span> <span class="pre">MD</span></code> expects a number of input files, these are two essential files, e.g. <code class="docutils literal notranslate"><span class="pre">complex.pdb</span></code> and <code class="docutils literal notranslate"><span class="pre">complex.prmtop</span></code>.
These files contain information about the position, topology and parameters for the system. Currently we only support
the <code class="docutils literal notranslate"><span class="pre">AMBER</span></code> based format <code class="docutils literal notranslate"><span class="pre">prmtop</span></code>. <code class="docutils literal notranslate"><span class="pre">complex.pdb</span></code> also contains the alchemical indexes denoting which atoms will
appear and disappear during the simulation. There is also an optional input file, <code class="docutils literal notranslate"><span class="pre">constraints.pdb</span></code>, and this
contains indexes denoting which atoms, if any, are constrained during the pre-production simulation. This input should
all be placed in a directory named build located where the user wishes to run the simulation. Examples of these files
can be found <a class="reference external" href="https://github.com/UCL-CCS/TIES_MD/tree/master/TIES_MD/examples">here</a>.</p>
<p>Please use a directory structure like <code class="docutils literal notranslate"><span class="pre">study/system/ligand/thermodynamic_leg/build</span></code> this will allow the analysis scripts to
understand the structure and perform analysis automatically. <code class="docutils literal notranslate"><span class="pre">study</span></code>, <code class="docutils literal notranslate"><span class="pre">system</span></code>, <code class="docutils literal notranslate"><span class="pre">ligand</span></code> and <code class="docutils literal notranslate"><span class="pre">thermodynamic_leg</span></code>
can be renamed to anything but the name of the <code class="docutils literal notranslate"><span class="pre">build</span></code> directory is fixed. If input for novel ligand transformations is desired the
<a class="reference external" href="https://github.com/UCL-CCS/TIES20">TIES20</a> program can be used to generate all required inputs. <code class="docutils literal notranslate"><span class="pre">TIES</span> <span class="pre">20</span></code> can be
used via our online <a class="reference external" href="https://ccs-ties.org/ties/">service</a> or locally and details of how to use this will be provided
later in these documents.</p>
<p>The only non standard input to <code class="docutils literal notranslate"><span class="pre">TIES</span> <span class="pre">MD</span></code> is a configuration file (<code class="docutils literal notranslate"><span class="pre">TIES.cfg</span></code>) which specifies options which the user my wish to
occasionally change. This file must be placed alongside the build directory. Here we provide an example of such a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#################################################################</span>
<span class="c1">#                                                               #</span>
<span class="c1">#                             TIES                              #</span>
<span class="c1">#                                                               #</span>
<span class="c1">#################################################################</span>

<span class="c1">#Which molecular dynamics engine will be used, valid options are openmm/namd2.14/namd3</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">openmm</span>

<span class="c1">#Target temperature for the thermostat</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="mi">300</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">kelvin</span>

<span class="c1">#Target pressure for barostat</span>
<span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">atmospheres</span>

<span class="c1">#How much production sampling to run per alchemical window (4ns recommended)</span>
<span class="n">sampling_per_window</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">nanoseconds</span>

<span class="c1">#How much equilibration to run per alchemical window (2ns recommended)</span>
<span class="n">equili_per_window</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">unit</span><span class="o">.</span><span class="n">nanoseconds</span>

<span class="c1">#Which estimators to use. Valid options are: TI, FEP</span>
<span class="n">methods</span> <span class="o">=</span> <span class="n">FEP</span><span class="p">,</span> <span class="n">TI</span>

<span class="c1">#How many total replicas of each window are run (we recommend at least 5).</span>
<span class="n">total_reps</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1">#Boolean for if we will split all replicas into separate runs. (1 for maximum parallelism)</span>
<span class="n">split_run</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">#Where in lambda schedule (0-&gt;1) should the electrostatic potentials begin, stop appearing.</span>
<span class="n">elec_edges</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span>

<span class="c1">#Where in lambda schedule (0-&gt;1) should the Lennard_Jones potentials begin, stop appearing.</span>
<span class="n">ster_edges</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span>

<span class="c1">#The value the global controlling parameter takes in each window (13 windows of this spacing recommended)</span>
<span class="n">global_lambdas</span> <span class="o">=</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.00</span>

<span class="c1">#The name of the pdb file with constraints in the build directory, i.e. cons.pdb If no constraints pass na</span>
<span class="n">constraint_file</span> <span class="o">=</span> <span class="n">na</span>

<span class="c1">#Which column in pdb are constraints provided valid options are occupancy/beta_factor. (beta_factor is standard)</span>
<span class="n">constraint_column</span> <span class="o">=</span> <span class="n">beta_factor</span>

<span class="c1">#Manually specify box vectors of this simulation, unit Angstrom.</span>
<span class="n">cell_basis_vec1</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
<span class="n">cell_basis_vec2</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">0.0</span>
<span class="n">cell_basis_vec3</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">50</span>

<span class="c1">#What input type is provided, only AMBER supported.</span>
<span class="n">input_type</span> <span class="o">=</span> <span class="n">AMBER</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">total_reps</span></code> and <code class="docutils literal notranslate"><span class="pre">split_run</span></code> are options which can be used to achieve simple parallelism of the simulations.
For example if you wished to run a total of 5 simulations on 5 GPUs in parallel one could use the settings
<code class="docutils literal notranslate"><span class="pre">total_reps</span> <span class="pre">=</span> <span class="pre">5</span></code> and <code class="docutils literal notranslate"><span class="pre">split_run</span> <span class="pre">=</span> <span class="pre">1</span></code>. See the <a class="reference internal" href="parallelization.html#parallelization"><span class="std std-ref">Parallelization</span></a> section for more details of how to
achieve this.</p>
<p>The following image shows <code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code> applied to one alchemical transformation.</p>
<a class="reference internal image-reference" href="_images/one_leg.png"><img alt="Alternative text" class="align-center" src="_images/one_leg.png" style="width: 600px;" /></a>
<p>The setting <code class="docutils literal notranslate"><span class="pre">global_lambdas</span></code> defines the values the alchemical parameter <code class="docutils literal notranslate"><span class="pre">Œª</span></code> will take in each alchemical
windows. <code class="docutils literal notranslate"><span class="pre">global_lambdas</span></code> should run from 0 to 1. As <code class="docutils literal notranslate"><span class="pre">global_lambdas</span></code> varies from 0 to 1 some atoms in the
system are turned on and off moving the system between two physical states (see <a class="reference internal" href="theory.html#alchemical-calculations"><span class="std std-ref">Alchemical Calculations</span></a>).
The values given to <code class="docutils literal notranslate"><span class="pre">elec_edges</span></code> and <code class="docutils literal notranslate"><span class="pre">ster_edges</span></code> define exactly how <code class="docutils literal notranslate"><span class="pre">Œª</span></code> modifies the potential
energy functions of the system and for more information these settings please see the <a class="reference internal" href="theory.html#alchemical-pathways"><span class="std std-ref">Alchemical Pathways</span></a> section.</p>
<p>Note the option <code class="docutils literal notranslate"><span class="pre">constraint_column</span></code> which determines if the constraint indexes will be read from the temperature factor
or occupancy column of the constraints PDB. The alchemical indexes are always be read from the temperature factor column
in the main PDB <code class="docutils literal notranslate"><span class="pre">complex.pdb</span></code>. <code class="docutils literal notranslate"><span class="pre">TIES20</span></code> will populate a TIES.cfg automatically with the correct box size.</p>
<p>Typically a constraint file may be used during preproduction of simulations involving proteins but possibly not a small
drug like molecule in only solvent. It will be shown later in the <a class="reference internal" href="binding_free_energies.html#binding-free-energy-tutorial"><span class="std std-ref">Binding Free Energy Tutorial</span></a> section when and
why we use a constraints file.</p>
</section>
<section id="command-line">
<h2>Command Line<a class="headerlink" href="#command-line" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>With all input present in the build directory and <code class="docutils literal notranslate"><span class="pre">TIES</span> <span class="pre">MD</span></code> installed we are almost ready to calculate binding
free energies. <code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code> can be invoked on the command line by just running <code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code> and this will use all default
settings and the settings found in <code class="docutils literal notranslate"><span class="pre">TIES.cfg</span></code>. The setting which can be taken on the command line and their default
values are as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[--config_file=./TIES.cfg]
A string for the path pointing to where the TIES.cfg file is located.

[--exp_name=complex]
This is the name of the experiment and the prefix that TIES OpenMM will expect on the input pdb and prmtop file.
Note that the constraints pdb is specified separately in the config file.

[--run_type=run]
A string either `run`, `setup` or `class`. `run` will tell TIES OpenMM to execute the binding free energy calculation,
`setup` will prep the output directories and `class` will halt the program after the construction of the TIES class,
 this can be used in testing or advanced analysis.

[--windows_mask=None]
Comma separated list of integers. These specify what alchemical windows the current instance of TIES OpenMM should
run. By default all windows will be run.

# Below are OpenMM specific options, these are silently ignored for NAMD runs.

[--devices=0]
A comma separated list of integers which tells TIES OpenMM which GPUs to run on. If multiple GPUs
are specified then TIES OpenMM will parallelize requested replicas over the available GPUs.

[--rep_id=0]
An int which will be used to generate the names of output files. Should be used if many independent replicas of the
same simulation are run on different nodes to ensure output is writen to unique location.
</pre></div>
</div>
</section>
<section id="simulation-preparation">
<h2>Simulation Preparation<a class="headerlink" href="#simulation-preparation" title="Permalink to this heading">ÔÉÅ</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code> is run in two stages first using the option <code class="docutils literal notranslate"><span class="pre">--run_type=setup</span></code> this prepares output directories and MD engine
input scripts, this stage is not compute intensive and can be run on a PC or HPC head node. The setup stage can but does
not have to be run of you are using <code class="docutils literal notranslate"><span class="pre">OpenMM</span></code> and directories are built when using <code class="docutils literal notranslate"><span class="pre">--run_type=run</span></code> also. Output directories are prepared
with the structure <code class="docutils literal notranslate"><span class="pre">LAMBDA_X</span></code> where <code class="docutils literal notranslate"><span class="pre">X</span></code> is a float denoting what alchemical window that folder contains the output for.
Within <code class="docutils literal notranslate"><span class="pre">LAMBDA_X</span></code> there are directories named <code class="docutils literal notranslate"><span class="pre">repY</span></code> where <code class="docutils literal notranslate"><span class="pre">Y</span></code> is an integer which denotes a replica in the ensemble. In the
<code class="docutils literal notranslate"><span class="pre">repY</span></code> directories there are three more directories: <code class="docutils literal notranslate"><span class="pre">equilibration</span></code>, <code class="docutils literal notranslate"><span class="pre">simulation</span></code> and <code class="docutils literal notranslate"><span class="pre">results</span></code>. The <code class="docutils literal notranslate"><span class="pre">equilibration</span></code> and
<code class="docutils literal notranslate"><span class="pre">simulation</span></code> directory will contain all the output for the pre-production and production stages of the simulation
respectively. The <code class="docutils literal notranslate"><span class="pre">results</span></code> directory will contain the files with potentials and gradients output by <code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code> or <code class="docutils literal notranslate"><span class="pre">NAMD</span></code>.
The files in the <code class="docutils literal notranslate"><span class="pre">results</span></code> directories will be analysed to calculate binding free energies. Considering the application of
this setup stage to <a class="reference external" href="https://github.com/UCL-CCS/TIES_MD/tree/master/TIES_MD/examples/OpenMM/ethane/zero_sum/leg1">this</a> example
for the zero sum transformation of ethane to ethane the setup command would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ties_md</span> <span class="o">--</span><span class="n">exp_name</span><span class="o">=</span><span class="n">sys_solv</span> <span class="o">--</span><span class="n">run_type</span><span class="o">=</span><span class="n">setup</span>
</pre></div>
</div>
<p>The above sets up an <code class="docutils literal notranslate"><span class="pre">OpenMM</span></code> calculation. Alternatively to use <code class="docutils literal notranslate"><span class="pre">NAMD</span></code> some options must be changed please see this
<a class="reference external" href="https://github.com/UCL-CCS/TIES_MD/blob/master/TIES_MD/examples/NAMD/ethane_namd/zero_sum/leg1/TIES.cfg">modified</a> config file
as an example of what to change.</p>
</section>
<section id="running-simulations">
<h2>Running Simulations<a class="headerlink" href="#running-simulations" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>The second stage of running <code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code>, after setup, involves the running of the MD simulations, this is compute intensive
and can only be run on a HPC for all but the smallest systems. The execution of <code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code> branches at this point dependant
on what MD engine is being used. HPC submission scripts should be prepared with the target MD engine in mind.</p>
<p>Consider the same <a class="reference external" href="https://github.com/UCL-CCS/TIES_MD/tree/master/TIES_MD/examples/OpenMM/ethane/zero_sum/leg1">example,</a> used in the
setup stage, for the transformation of ethane to ethane. If in TIES.cfg the option <code class="docutils literal notranslate"><span class="pre">global_lambdas</span></code> is set
equal to <code class="docutils literal notranslate"><span class="pre">0.0,</span> <span class="pre">0.2,</span> <span class="pre">0.4,</span> <span class="pre">0.6,</span> <span class="pre">0.8,</span> <span class="pre">1.0</span></code> there are 6 alchemical windows and the option <code class="docutils literal notranslate"><span class="pre">total_reps</span></code> is set equal
to <code class="docutils literal notranslate"><span class="pre">1</span></code>, there is therefore 6x1 = 6 total simulations to perform. If a HPC submission script was to request one node with
6 GPUS with each GPU running one alchemical window the run lines for an <code class="docutils literal notranslate"><span class="pre">OpenMM</span></code> calculation would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ties_md</span> <span class="o">--</span><span class="n">exp_name</span><span class="o">=</span><span class="n">sys_solv</span> <span class="o">--</span><span class="n">windows_mask</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="o">--</span><span class="n">devices</span><span class="o">=</span><span class="mi">0</span><span class="o">&amp;</span>
<span class="n">ties_md</span> <span class="o">--</span><span class="n">exp_name</span><span class="o">=</span><span class="n">sys_solv</span> <span class="o">--</span><span class="n">windows_mask</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="o">--</span><span class="n">devices</span><span class="o">=</span><span class="mi">1</span><span class="o">&amp;</span>
<span class="n">ties_md</span> <span class="o">--</span><span class="n">exp_name</span><span class="o">=</span><span class="n">sys_solv</span> <span class="o">--</span><span class="n">windows_mask</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span> <span class="o">--</span><span class="n">devices</span><span class="o">=</span><span class="mi">2</span><span class="o">&amp;</span>
<span class="n">ties_md</span> <span class="o">--</span><span class="n">exp_name</span><span class="o">=</span><span class="n">sys_solv</span> <span class="o">--</span><span class="n">windows_mask</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span> <span class="o">--</span><span class="n">devices</span><span class="o">=</span><span class="mi">3</span><span class="o">&amp;</span>
<span class="n">ties_md</span> <span class="o">--</span><span class="n">exp_name</span><span class="o">=</span><span class="n">sys_solv</span> <span class="o">--</span><span class="n">windows_mask</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span> <span class="o">--</span><span class="n">devices</span><span class="o">=</span><span class="mi">4</span><span class="o">&amp;</span>
<span class="n">ties_md</span> <span class="o">--</span><span class="n">exp_name</span><span class="o">=</span><span class="n">sys_solv</span> <span class="o">--</span><span class="n">windows_mask</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span> <span class="o">--</span><span class="n">devices</span><span class="o">=</span><span class="mi">5</span><span class="o">&amp;</span>
</pre></div>
</div>
<p>There are a lot of options for how these <code class="docutils literal notranslate"><span class="pre">OpenMM</span></code> calculations can be structured and parallelized with <code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code> see our
<a class="reference internal" href="parallelization.html#parallelization"><span class="std std-ref">Parallelization</span></a> page for more information on this. For a <code class="docutils literal notranslate"><span class="pre">NAMD</span></code> calculation if the submission script requested 6 CPU
nodes each with 128 cores the run lines in the submission script might look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd $build/replica-confs
for stage in {0..3}; do
     for lambda in in 0.0 0.2 0.4 0.6 0.8 1.0; do
         for i in {0..0}; do
             srun -N 1 -n 128 namd2 --tclmain run$stage.conf $lambda $i &amp;
             sleep 1
         done
     done
     wait
 done
</pre></div>
</div>
<p>Notice in the <code class="docutils literal notranslate"><span class="pre">NAMD</span></code> example reference is made to a directory <code class="docutils literal notranslate"><span class="pre">$build/replica-confs</span></code> this is where the NAMD input scripts are writen
during the <code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code> setup stage. Also notice in the <code class="docutils literal notranslate"><span class="pre">NAMD</span></code> examples there is a loop over the <code class="docutils literal notranslate"><span class="pre">stages</span></code> these are three
pre-production stages and one production stage. The preproduction stages are a minimization followed by an NVT equilibration
and finishing with NPT equilibration. The production stage is NVT simulation, it is the production simulation which is
analysed to calculate the results. These stages are performed automatically by <code class="docutils literal notranslate"><span class="pre">TIES</span> <span class="pre">MD</span></code> when running with
<code class="docutils literal notranslate"><span class="pre">OpenMM</span></code> but must be explicitly executed when using <code class="docutils literal notranslate"><span class="pre">NAMD</span></code> as shown above. The exact submission script for a particular
HPC and the settings with which each engine should be run to get good performance is a wide problem without a general
solution to solve any issues we would suggest consulting user manuals of both HPC and MD engine, reading our example <a class="reference internal" href="HPC_submissions.html#hpc-submission-scripts"><span class="std std-ref">HPC Submission scripts</span></a> or submitting an <a class="reference external" href="https://github.com/UCL-CCS/TIES_MD/issues">issue</a> on <code class="docutils literal notranslate"><span class="pre">Github</span></code>.</p>
</section>
<section id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>The analysis of the files found in the output can be performed by <code class="docutils literal notranslate"><span class="pre">TIES_analysis</span></code> which is a submodule of <code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code>.
<code class="docutils literal notranslate"><span class="pre">TIES_MD</span></code> will create the input needed to perform the analysis. Input configuration files for <code class="docutils literal notranslate"><span class="pre">TIES_analysis</span></code> will be filled
in with information such as the lambda schedule or which MD engine was used. If the directory structure
<code class="docutils literal notranslate"><span class="pre">study/system/ligand/thermodynamic_leg/build</span></code> was used then these config files are written to the <code class="docutils literal notranslate"><span class="pre">study</span></code> directory.
Some information is missing from these config files which must be filled out. The missing information is for the names
of the <code class="docutils literal notranslate"><span class="pre">thermodynamic_leg</span></code> directories. Add the names of the <code class="docutils literal notranslate"><span class="pre">thermodynamic_leg</span></code> to the
config file <code class="docutils literal notranslate"><span class="pre">analysis.cfg</span></code> under the option <code class="docutils literal notranslate"><span class="pre">legs</span></code> as an example see the option <a class="reference external" href="https://github.com/UCL-CCS/TIES_MD/blob/main/TIES_MD/examples/OpenMM/analysis.cfg">legs</a>
in this example script. This example analysis input also has an <code class="docutils literal notranslate"><span class="pre">exp.dat</span></code> <a class="reference external" href="https://github.com/UCL-CCS/TIES_MD/blob/main/TIES_MD/examples/OpenMM/exp.dat">file</a>
populated for the system named <code class="docutils literal notranslate"><span class="pre">ethane</span></code> and a ligand transformation in that system called <code class="docutils literal notranslate"><span class="pre">zero_sum</span></code>, this transformation
has an theoretical ŒîG of 0.0 kcal/mol and an unknown standard deviation associated with that measurement. Any unknown
values in <code class="docutils literal notranslate"><span class="pre">exp.dat</span></code> which need to be populated can be left as 0.0. The theoretical ŒîG of this ethane zero sum system is zero
because the transformation carried out is ethane into ethane so we should expect the result to sum to zero. This is not
the result we would expect in general and is special only to a test case such as this. To save time an <code class="docutils literal notranslate"><span class="pre">exp.dat</span></code> file
with all values set to 0.0 can be generated with <code class="docutils literal notranslate"><span class="pre">TIES_analysis</span></code> by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ties_ana</span> <span class="o">--</span><span class="n">run_type</span><span class="o">=</span><span class="n">setup</span>
</pre></div>
</div>
<p>The information in the generated <code class="docutils literal notranslate"><span class="pre">exp.dat</span></code> will be inferred from the directory structure.
If desired the user can populate the <code class="docutils literal notranslate"><span class="pre">exp.dat</span></code> correct (non-zero) values at a later date for their own reference/analysis.
With <code class="docutils literal notranslate"><span class="pre">analysis.cfg</span></code> and <code class="docutils literal notranslate"><span class="pre">exp.dat</span></code> populated the analysis can then be executed on a HPC head node or PC by running
<code class="docutils literal notranslate"><span class="pre">TIES_analysis</span></code> in the <code class="docutils literal notranslate"><span class="pre">study</span></code> directory using the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ties_ana</span>
</pre></div>
</div>
<p>This will produce as output a file <code class="docutils literal notranslate"><span class="pre">results.dat</span></code> in the <code class="docutils literal notranslate"><span class="pre">study</span></code> directory which contains a python dictionary keyed
first by the methodology used, then the system name and then ligand name. Each value in the dictionary is a list, the first
entry in that list is the calculated free energy change and the second entry is the standard deviation associated with
that free energy change. So for example the <code class="docutils literal notranslate"><span class="pre">results.dat</span></code> output from the ethane to ethane transformation example
would look something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#METHOD          SYSTEM     LIGAND</span>
<span class="p">{</span><span class="s1">&#39;OpenMM_FEP&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ethane&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;zero_sum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.023</span><span class="p">,</span> <span class="mf">0.023</span><span class="p">]}},</span>
  <span class="s1">&#39;OpenMM_TI&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ethane&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;zero_sum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.003</span><span class="p">,</span> <span class="mf">0.076</span><span class="p">]}}}</span>
</pre></div>
</div>
<p>To complement this main output <code class="docutils literal notranslate"><span class="pre">TIES_analysis</span></code> will also produce analysis figures which should help in determining the
validity and accuracy of calculations. <code class="docutils literal notranslate"><span class="pre">TIES_analysis</span></code> will place these figures in a new directory named
<code class="docutils literal notranslate"><span class="pre">analysis/engine/method/system/ligand/thermodynamic_leg/</span></code></p>
<a class="reference internal image-reference" href="_images/analysis.png"><img alt="Alternative text" class="align-center" src="_images/analysis.png" style="width: 600px;" /></a>
<p>Panel a) pertains to FEP results and measures the overlap in phase space between alchemical states (Œª index).
If the off diagonal element of this matrix are less then 0.03 then this can serve as a warning to the user if their
states are too far apart. Please see the work of <a class="reference external" href="https://arxiv.org/pdf/2008.03067.pdf">Mey et al.</a> for more
details on this analysis.</p>
<p>Panel b) pertains to TI results and shows gradient of the potential with respect to the alchemical controlling
parameter (Œª) rapid changes in this gradient warn the user that the results may be inaccurate. As an example see the
following figure:</p>
<a class="reference internal image-reference" href="_images/TI_grad.jpeg"><img alt="Alternative text" class="align-center" src="_images/TI_grad.jpeg" style="width: 600px;" /></a>
<p>Panel a) show the analysis for a calculation where the gradient of ‚ÄòŒª sterics disappear‚Äô is changing too quickly in
states 12 - 13. This will lead to inaccuracies in numerical integration used in the TI method. Panel b) shows the
results from a simulation of the same chemical system with modified alchemical settings which soften how the Van der Waals
forces are removed. This <a class="reference external" href="http://alchemistry.org/wiki/Constructing_a_Pathway_of_Intermediate_States#Soft_Core_Potentials">softening</a>
is a common in alchemical methods and default in our implementation of <code class="docutils literal notranslate"><span class="pre">TIES</span></code>, please see our <code class="docutils literal notranslate"><span class="pre">TIES</span></code>
<a class="reference external" href="https://pubs.acs.org/doi/pdf/10.1021/acs.jctc.2c00114">paper</a> for more details.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="install.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="API.html" class="btn btn-neutral float-right" title="TIES MD API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, UCL CCS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>